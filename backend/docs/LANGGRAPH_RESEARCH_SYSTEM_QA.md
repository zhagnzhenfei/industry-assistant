# LangGraph ç ”ç©¶ç³»ç»Ÿ - æŠ€æœ¯é—®ç­”æ–‡æ¡£

> æœ¬æ–‡æ¡£æ•´ç†äº†ç ”ç©¶ç³»ç»Ÿçš„æ ¸å¿ƒæ¦‚å¿µã€æ¶æ„è®¾è®¡å’Œå¸¸è§é—®é¢˜è§£ç­”

## ç›®å½•

1. [æµå¼å“åº”æ¶æ„](#1-æµå¼å“åº”æ¶æ„)
2. [æ ¸å¿ƒå‡½æ•°è§£æ](#2-æ ¸å¿ƒå‡½æ•°è§£æ)
3. [LangGraph å·¥ä½œæµ](#3-langgraph-å·¥ä½œæµ)
4. [å·¥å…·ç³»ç»Ÿæ¶æ„](#4-å·¥å…·ç³»ç»Ÿæ¶æ„)
5. [å¦‚ä½•æ‰©å±•ç³»ç»Ÿ](#5-å¦‚ä½•æ‰©å±•ç³»ç»Ÿ)

---

## 1. æµå¼å“åº”æ¶æ„

### 1.1 åˆå§‹åŒ–æ¶ˆæ¯çš„ä½œç”¨

**Q: è·¯ç”±å±‚å‘é€çš„åˆå§‹åŒ–æ¶ˆæ¯æœ‰ä»€ä¹ˆç”¨ï¼Ÿ**

```python
# app/router/enhanced_research_router_simple.py
initial_data = {
    'type': 'start',
    'research_id': research_id,
    'question': request.question,
    'message': 'ğŸš€ å¼€å§‹å¤„ç†ç ”ç©¶è¯·æ±‚',
    'timestamp': datetime.now().isoformat()
}
yield f"data: {json.dumps(initial_data, ensure_ascii=False)}\n\n"
```

**A: è¿™æ˜¯ä¸ºäº†ç”¨æˆ·ä½“éªŒè®¾è®¡çš„**

ä¸»è¦ä½œç”¨ï¼š
1. âœ… **ç¡®è®¤è¿æ¥å»ºç«‹** - è®©å‰ç«¯çŸ¥é“ SSE è¿æ¥å·²æˆåŠŸ
2. âœ… **ç«‹å³åé¦ˆ** - é¿å…ç”¨æˆ·ç­‰å¾…æ—¶æ²¡æœ‰ä»»ä½•å“åº”
3. âœ… **ä¼ é€’ research_id** - å‰ç«¯å¯ä»¥ç«‹å³è·å–ä»»åŠ¡ ID ç”¨äºè¿½è¸ª

ä»ä¸šåŠ¡é€»è¾‘è§’åº¦çœ‹ï¼Œè¿™æ¡æ¶ˆæ¯ä¸åŒ…å«å®è´¨ç ”ç©¶å†…å®¹ï¼Œåªæ˜¯"æˆ‘å¼€å§‹å·¥ä½œäº†"çš„é€šçŸ¥ã€‚

---

### 1.2 async for å’Œ yield è¯­æ³•è§£æ

**Q: è¿™ç§å†™æ³•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ**

```python
async for progress_data in execute_research_task_stream(...):
    # å¤„ç†æ¯ä¸ªè¿›åº¦æ•°æ®
    yield f"data: {json.dumps(progress_data, ensure_ascii=False)}\n\n"
```

**A: è¿™æ˜¯ Python çš„å¼‚æ­¥ç”Ÿæˆå™¨æ¨¡å¼**

#### æ ¸å¿ƒæ¦‚å¿µ

1. **`async for` - å¼‚æ­¥è¿­ä»£å™¨**
   - `execute_research_task_stream` è¿”å›ä¸€ä¸ªå¼‚æ­¥ç”Ÿæˆå™¨
   - `async for` ä¼šç­‰å¾…æ¯æ¬¡äº§ç”Ÿçš„æ•°æ®ï¼Œå¤„ç†åå†ç»§ç»­
   - ç›¸å½“äºï¼š"æˆ‘ä¼šä¸€ç›´ç­‰ç€ä½ ï¼Œæ¯æ¬¡ä½ ç»™æˆ‘ä¸€ç‚¹æ•°æ®ï¼Œæˆ‘å°±å¤„ç†ä¸€ç‚¹"

2. **`yield` - ç”Ÿæˆå™¨è¯­æ³•**
   - æ™®é€šå‡½æ•°ç”¨ `return` è¿”å›ä¸€æ¬¡å°±ç»“æŸ
   - ç”Ÿæˆå™¨å‡½æ•°ç”¨ `yield` å¯ä»¥**å¤šæ¬¡è¿”å›æ•°æ®**
   - æ¯æ¬¡ `yield` ä¼šæš‚åœå‡½æ•°ï¼Œç­‰å¾…ä¸‹æ¬¡è°ƒç”¨æ—¶ç»§ç»­

#### å®Œæ•´çš„æµå¼å¤„ç†é“¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ - æ”¶åˆ°æ•°æ®æµ                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†‘
                         â”‚ SSE æµå¼å“åº”
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  generate_research_stream() (å°è£…å±‚)                         â”‚
â”‚  â†“                                                            â”‚
â”‚  1. yield åˆå§‹æ¶ˆæ¯                                           â”‚
â”‚  2. async for å¾ªç¯æ¥æ”¶ä¸‹æ¸¸æ•°æ®                               â”‚
â”‚  3. yield æ¯æ¡è¿›åº¦æ•°æ®                                       â”‚
â”‚  4. yield å®Œæˆæ¶ˆæ¯                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†‘
                         â”‚ å¼‚æ­¥è¿­ä»£
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  execute_research_task_stream() (æ ¸å¿ƒå±‚)                    â”‚
â”‚  â†“                                                            â”‚
â”‚  1. yield è§„åˆ’é˜¶æ®µæ•°æ®                                       â”‚
â”‚  2. yield æ‰§è¡Œé˜¶æ®µæ•°æ®                                       â”‚
â”‚  3. yield æœ€ç»ˆç»“æœæ•°æ®                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸ºä»€ä¹ˆè¦è¿™æ ·å†™ï¼Ÿ

**ä¼ ç»Ÿæ–¹å¼ï¼ˆåŒæ­¥ç­‰å¾…ï¼‰**ï¼š
```python
# âŒ ä¸å¥½çš„æ–¹å¼
async def bad_way():
    result = await execute_research_task()  # ç­‰å¾…å…¨éƒ¨å®Œæˆ
    return result  # ä¸€æ¬¡æ€§è¿”å›
# ç”¨æˆ·è¦ç­‰å¾ˆä¹…æ‰èƒ½çœ‹åˆ°ç»“æœï¼
```

**æµå¼æ–¹å¼ï¼ˆå®æ—¶æ¨é€ï¼‰**ï¼š
```python
# âœ… å¥½çš„æ–¹å¼
async def good_way():
    async for progress in execute_research_task_stream():
        yield progress  # å®æ—¶æ¨é€è¿›åº¦
# ç”¨æˆ·å¯ä»¥å®æ—¶çœ‹åˆ°è¿›å±•ï¼
```

---

### 1.3 ä¸‰å±‚æ¶æ„è®¾è®¡

```python
# ã€ç¬¬ä¸€å±‚ã€‘è·¯ç”±å±‚ - FastAPI ç«¯ç‚¹
@router.post("/generate")
async def generate_enhanced_research_report(request):
    
    # ã€ç¬¬äºŒå±‚ã€‘æµå¼å°è£…å±‚ - å¤„ç†æµå¼å“åº”æ ¼å¼
    async def generate_research_stream():
        yield "åˆå§‹æ¶ˆæ¯"
        
        # è°ƒç”¨æ ¸å¿ƒå‡½æ•°
        async for progress_data in execute_research_task_stream(...):
            # å¯¹æ¯ä¸ª progress_data è¿›è¡Œå¤„ç†
            å¤„ç†æ—¥å¿—(progress_data)
            yield progress_data  # è½¬å‘ç»™å‰ç«¯
        
        yield "å®Œæˆæ¶ˆæ¯"
    
    # è¿”å›æµå¼å“åº”
    return StreamingResponse(generate_research_stream())
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- âœ… **èŒè´£åˆ†ç¦»** - è·¯ç”±ã€å°è£…ã€ä¸šåŠ¡é€»è¾‘å„å¸å…¶èŒ
- âœ… **å¯å¤ç”¨æ€§** - æ ¸å¿ƒå‡½æ•°å¯ä»¥è¢«ä¸åŒè·¯ç”±å¤ç”¨
- âœ… **æ˜“äºæµ‹è¯•** - æ¯å±‚å¯ä»¥ç‹¬ç«‹æµ‹è¯•

---

## 2. æ ¸å¿ƒå‡½æ•°è§£æ

### 2.1 execute_research_task_stream å‡½æ•°

**Q: è¿™ä¸ªå‡½æ•°åšä»€ä¹ˆï¼Ÿ**

```python
async def execute_research_task_stream(
    research_id: str,
    question: str,
    user_context: Optional[Dict[str, Any]] = None,
    allow_clarification: bool = False,
    research_depth: str = "comprehensive"
) -> AsyncGenerator[Dict[str, Any], None]:
```

**A: è¿™æ˜¯æ•´ä¸ªç ”ç©¶ç³»ç»Ÿçš„æ ¸å¿ƒå¼•æ“**

#### æ‰§è¡Œæµç¨‹ï¼ˆ6ä¸ªé˜¶æ®µï¼‰

```
1ï¸âƒ£ åˆå§‹åŒ–é˜¶æ®µ (5%)
   â”œâ”€ å‘é€åˆå§‹åŒ–è¿›åº¦ä¿¡æ¯
   â”œâ”€ åˆ›å»º ResearchResult ä»»åŠ¡è®°å½•
   â””â”€ ä¿å­˜åˆ° research_tasks å­—å…¸

2ï¸âƒ£ ç¯å¢ƒé…ç½®é˜¶æ®µ (10%)
   â”œâ”€ å‘é€é…ç½®è¿›åº¦ä¿¡æ¯
   â””â”€ è·å–ç¼–æ’å™¨å®ä¾‹ (get_orchestrator)

3ï¸âƒ£ é—®é¢˜åˆ†æé˜¶æ®µ (15%)
   â””â”€ å‘é€åˆ†æè¿›åº¦ä¿¡æ¯

4ï¸âƒ£ ç ”ç©¶æ‰§è¡Œé˜¶æ®µ (20% â†’ 90%)
   â”œâ”€ è°ƒç”¨ç¼–æ’å™¨å¤„ç†ç ”ç©¶è¯·æ±‚
   â”œâ”€ æ‰§è¡Œå®é™…çš„ç ”ç©¶é€»è¾‘ï¼ˆæœç´¢ã€åˆ†æç­‰ï¼‰
   â””â”€ è¿™æ˜¯æœ€è€—æ—¶çš„é˜¶æ®µï¼

5ï¸âƒ£ æŠ¥å‘Šç”Ÿæˆé˜¶æ®µ (95%)
   â”œâ”€ è®¡ç®—è´¨é‡è¯„åˆ†
   â””â”€ å‡†å¤‡æœ€ç»ˆæŠ¥å‘Šæ•°æ®

6ï¸âƒ£ å®Œæˆé˜¶æ®µ (100%)
   â””â”€ å‘é€æœ€ç»ˆç»“æœï¼ˆåŒ…å«å®Œæ•´æŠ¥å‘Šï¼‰
```

#### æ•°æ®ç±»å‹

å‡½æ•°ä¼š `yield` ä¸‰ç§ç±»å‹çš„æ•°æ®ï¼š

| type | è¯´æ˜ | ä½•æ—¶å‘é€ | å‰ç«¯å¤„ç† |
|------|------|---------|---------|
| `'progress'` | è¿›åº¦æ›´æ–° | æ•´ä¸ªæµç¨‹ä¸­å¤šæ¬¡å‘é€ | æ›´æ–°è¿›åº¦æ¡ã€æ˜¾ç¤ºçŠ¶æ€ |
| `'result'` | æœ€ç»ˆç»“æœ | ç ”ç©¶å®Œæˆæ—¶å‘é€ä¸€æ¬¡ | æ˜¾ç¤ºå®Œæ•´æŠ¥å‘Š |
| `'error'` | é”™è¯¯ä¿¡æ¯ | å‘ç”Ÿå¼‚å¸¸æ—¶å‘é€ | æ˜¾ç¤ºé”™è¯¯æç¤º |

#### å®Œæ•´æ•°æ®æµç¤ºä¾‹

å‡è®¾ç”¨æˆ·é—®ï¼š"AIçš„å‘å±•è¶‹åŠ¿"

```json
// 1ï¸âƒ£ yield (5%)
{
  "type": "progress",
  "stage": "initializing",
  "progress": 5.0,
  "message": "ğŸ”§ æ­£åœ¨åˆå§‹åŒ–ç ”ç©¶ç³»ç»Ÿ..."
}

// 2ï¸âƒ£ yield (10%)
{
  "type": "progress",
  "stage": "setup",
  "progress": 10.0,
  "message": "âš™ï¸ æ­£åœ¨é…ç½®ç ”ç©¶ç¯å¢ƒ..."
}

// 3ï¸âƒ£ yield (15%)
{
  "type": "progress",
  "stage": "analyzing",
  "progress": 15.0,
  "message": "ğŸ” æ­£åœ¨åˆ†æç ”ç©¶é—®é¢˜..."
}

// 4ï¸âƒ£ yield (20%)
{
  "type": "progress",
  "stage": "researching",
  "progress": 20.0,
  "message": "ğŸš€ å¼€å§‹æ‰§è¡Œç ”ç©¶æµç¨‹..."
}

// ... ç ”ç©¶è¿‡ç¨‹ï¼ˆå¯èƒ½å‡ åç§’åˆ°å‡ åˆ†é’Ÿï¼‰...

// 5ï¸âƒ£ yield (95%)
{
  "type": "progress",
  "stage": "completed",
  "progress": 95.0,
  "message": "ğŸ“ æ­£åœ¨ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š..."
}

// 6ï¸âƒ£ yield (100%) - æœ€ç»ˆç»“æœ
{
  "type": "result",
  "progress": 100.0,
  "message": "âœ… ç ”ç©¶ä»»åŠ¡å®Œæˆï¼",
  "final_report": "# AIå‘å±•è¶‹åŠ¿ç ”ç©¶æŠ¥å‘Š\n\nå®Œæ•´å†…å®¹...",
  "key_findings": ["å‘ç°1", "å‘ç°2", "å‘ç°3"],
  "quality_score": 85.5,
  "duration": 45.3
}
```

---

### 2.2 get_orchestrator å‡½æ•°

**Q: è¿™ä¸ªå‡½æ•°ä»€ä¹ˆä½œç”¨ï¼Ÿ**

```python
async def get_orchestrator(research_depth: str = "comprehensive") -> ODRResearchOrchestrator:
    """è·å–ç¼–æ’å™¨å®ä¾‹ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰"""
    global orchestrator

    if orchestrator is None:
        config = Configuration(...)
        orchestrator = ODRResearchOrchestrator(config)
        await orchestrator.initialize()

    return orchestrator
```

**A: è¿™æ˜¯ä¸€ä¸ªæ‡’åŠ è½½çš„å•ä¾‹å·¥å‚å‡½æ•°**

#### å•ä¾‹æ¨¡å¼çš„ä¼˜åŠ¿

```
âŒ ä¸ç”¨å•ä¾‹çš„é—®é¢˜
â”œâ”€ æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºæ–°å®ä¾‹
â”œâ”€ é‡å¤åˆå§‹åŒ–ï¼ˆè€—æ—¶ã€æ¶ˆè€—èµ„æºï¼‰
â”œâ”€ å¤šä¸ªå®ä¾‹ä¹‹é—´æ— æ³•å…±äº«çŠ¶æ€
â””â”€ å¯èƒ½å¯¼è‡´é…ç½®ä¸ä¸€è‡´

âœ… å•ä¾‹æ¨¡å¼çš„ä¼˜åŠ¿
â”œâ”€ å…¨å±€åªæœ‰ä¸€ä¸ªå®ä¾‹
â”œâ”€ åªåˆå§‹åŒ–ä¸€æ¬¡ï¼ˆèŠ‚çœæ—¶é—´å’Œèµ„æºï¼‰
â”œâ”€ æ‰€æœ‰ç ”ç©¶ä»»åŠ¡å…±äº«åŒä¸€ä¸ªç¼–æ’å™¨
â”œâ”€ é…ç½®ç»Ÿä¸€ç®¡ç†
â””â”€ å¯ä»¥åœ¨ç¼–æ’å™¨ä¸­ç»´æŠ¤å…¨å±€çŠ¶æ€
```

#### è°ƒç”¨æµç¨‹ç¤ºä¾‹

```python
# ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼ˆç”¨æˆ·Aå‘èµ·ç ”ç©¶è¯·æ±‚ï¼‰
orchestrator = await get_orchestrator("comprehensive")
# æ‰§è¡Œæµç¨‹ï¼š
# 1. orchestrator is None âœ… ä¸ºç©º
# 2. åˆ›å»º Configuration
# 3. åˆ›å»º ODRResearchOrchestrator å®ä¾‹
# 4. è°ƒç”¨ orchestrator.initialize() (å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ)
# 5. è¿”å›ç¼–æ’å™¨å®ä¾‹
# â±ï¸ è€—æ—¶ï¼š~3-5ç§’ï¼ˆéœ€è¦åˆå§‹åŒ–ï¼‰

# ç¬¬äºŒæ¬¡è°ƒç”¨ï¼ˆç”¨æˆ·Bå‘èµ·ç ”ç©¶è¯·æ±‚ï¼‰
orchestrator = await get_orchestrator("comprehensive")
# æ‰§è¡Œæµç¨‹ï¼š
# 1. orchestrator is None âŒ å·²å­˜åœ¨
# 2. ç›´æ¥è¿”å›ç°æœ‰å®ä¾‹
# â±ï¸ è€—æ—¶ï¼š~0.001ç§’ï¼ˆå‡ ä¹ç¬é—´ï¼‰
```

#### é…ç½®è¯´æ˜

```python
config = Configuration(
    max_concurrent_research_units=5,   # æœ€å¤šåŒæ—¶è¿›è¡Œ5ä¸ªç ”ç©¶å•å…ƒ
    max_researcher_iterations=6,       # ç ”ç©¶è¿­ä»£æœ€å¤š6æ¬¡
    max_react_tool_calls=10,           # ReActå·¥å…·è°ƒç”¨æœ€å¤š10æ¬¡
    allow_clarification=True,          # å…è®¸è¯·æ±‚æ¾„æ¸…
    search_api="serper"                # ä½¿ç”¨Serperæœç´¢API
)
```

---

## 3. LangGraph å·¥ä½œæµ

### 3.1 æ ¸å¿ƒæ‰§è¡Œä»£ç 

**Q: è¿™æ®µä»£ç åœ¨åšä»€ä¹ˆï¼Ÿ**

```python
# æ‰§è¡Œå›¾
logger.info("å¼€å§‹æ‰§è¡ŒLangGraph...")
final_state = await self.graph.ainvoke(initial_state, config)
logger.info(f"LangGraphæ‰§è¡Œå®Œæˆï¼Œæœ€ç»ˆçŠ¶æ€: {final_state}")
```

**A: è¿™æ˜¯æ•´ä¸ªç ”ç©¶ç³»ç»Ÿçš„æ ¸å¿ƒæ‰§è¡Œå¼•æ“**

è¿™ä¸€è¡Œä»£ç è§¦å‘äº†æ•´ä¸ª LangGraph å·¥ä½œæµï¼Œä»ç”¨æˆ·æé—®åˆ°æœ€ç»ˆæŠ¥å‘Šçš„å®Œæ•´ç ”ç©¶æµç¨‹ã€‚

#### LangGraph å·¥ä½œæµç»“æ„

```
    è¾“å…¥: initial_state = {"messages": [HumanMessage(content="AIçš„å‘å±•è¶‹åŠ¿")]}
    
    â†“ [START]
    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‘  clarify_with_user (æ¾„æ¸…é˜¶æ®µ)                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â€¢ æ£€æŸ¥é—®é¢˜æ˜¯å¦éœ€è¦æ¾„æ¸…                                          â”‚
â”‚ â€¢ å¦‚æœéœ€è¦æ¾„æ¸… â†’ END (è¿”å›æ¾„æ¸…é—®é¢˜)                             â”‚
â”‚ â€¢ å¦‚æœä¸éœ€è¦ â†’ ç»§ç»­ä¸‹ä¸€æ­¥                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‘¡ write_research_brief (è§„åˆ’é˜¶æ®µ)                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â€¢ å°†ç”¨æˆ·é—®é¢˜è½¬æ¢ä¸ºç»“æ„åŒ–ç ”ç©¶ç®€æŠ¥                                â”‚
â”‚ â€¢ åˆå§‹åŒ–ç ”ç©¶ç›‘ç£è€…çš„æŒ‡ä»¤                                        â”‚
â”‚ â€¢ å‡†å¤‡ç ”ç©¶ä¸Šä¸‹æ–‡                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‘¢ research_supervisor (æ‰§è¡Œé˜¶æ®µ) â­ æ ¸å¿ƒ                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â€¢ ç›‘ç£è€…è°ƒåº¦å¤šä¸ªç ”ç©¶å•å…ƒå¹¶è¡Œå·¥ä½œ                                â”‚
â”‚ â€¢ æ¯ä¸ªç ”ç©¶å•å…ƒè´Ÿè´£ä¸€ä¸ªå­ä»»åŠ¡                                    â”‚
â”‚ â€¢ ä½¿ç”¨ ReAct æ¨¡å¼è¿›è¡Œæ¨ç†å’Œå·¥å…·è°ƒç”¨                             â”‚
â”‚ â€¢ æ”¶é›†æ‰€æœ‰ç ”ç©¶å‘ç°                                              â”‚
â”‚                                                                 â”‚
â”‚   ç ”ç©¶å•å…ƒ 1 â”€â”                                                 â”‚
â”‚   ç ”ç©¶å•å…ƒ 2 â”€â”¤â†’ å¹¶è¡Œæ‰§è¡Œæœç´¢ã€åˆ†æ                             â”‚
â”‚   ç ”ç©¶å•å…ƒ 3 â”€â”˜                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â‘£ final_report_generation (æŠ¥å‘Šç”Ÿæˆé˜¶æ®µ)                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â€¢ æ•´åˆæ‰€æœ‰ç ”ç©¶å‘ç°                                              â”‚
â”‚ â€¢ ç”Ÿæˆç»“æ„åŒ–çš„æœ€ç»ˆæŠ¥å‘Š                                          â”‚
â”‚ â€¢ å¤„ç† token é™åˆ¶å’Œé‡è¯•                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    [END]
    
    è¾“å‡º: final_state = {
        "messages": [...],
        "research_brief": "...",
        "notes": [...],
        "final_report": "å®Œæ•´çš„ç ”ç©¶æŠ¥å‘Š...",
        ...
    }
```

#### å„é˜¶æ®µè¯¦è§£

**é˜¶æ®µ â‘ : clarify_with_user**
- åŠŸèƒ½ï¼šæ£€æŸ¥é—®é¢˜æ˜¯å¦æ¸…æ™°
- ç¤ºä¾‹ï¼š
  - ç”¨æˆ·ï¼š"AI" â†’ AIï¼š"æ‚¨æƒ³äº†è§£AIçš„å“ªä¸ªæ–¹é¢ï¼Ÿ" â†’ END
  - ç”¨æˆ·ï¼š"AIåœ¨åŒ»ç–—é¢†åŸŸçš„åº”ç”¨" â†’ AIï¼š"é—®é¢˜æ¸…æ™°" â†’ ç»§ç»­

**é˜¶æ®µ â‘¡: write_research_brief**
- åŠŸèƒ½ï¼šç”Ÿæˆç»“æ„åŒ–ç ”ç©¶ç®€æŠ¥
- è¾“å‡ºï¼š
  ```python
  {
      "research_brief": "ç ”ç©¶AIå‘å±•è¶‹åŠ¿ï¼š1. æŠ€æœ¯æ¼”è¿› 2. åº”ç”¨åœºæ™¯ 3. æœªæ¥æ–¹å‘",
      "supervisor_messages": [SystemMessage(...), HumanMessage(...)]
  }
  ```

**é˜¶æ®µ â‘¢: research_supervisor**ï¼ˆæœ€é‡è¦ï¼‰
- åŠŸèƒ½ï¼š
  1. è§„åˆ’ç ”ç©¶ä»»åŠ¡ï¼ˆå°†å¤§é—®é¢˜åˆ†è§£ä¸ºå­é—®é¢˜ï¼‰
  2. æ‰§è¡Œç ”ç©¶ï¼ˆæ¯ä¸ªç ”ç©¶å•å…ƒç‹¬ç«‹å·¥ä½œï¼‰
  3. ç›‘ç£å’Œåè°ƒï¼ˆè¯„ä¼°è¿›åº¦ï¼Œå†³å®šæ˜¯å¦ç»§ç»­ï¼‰

**é˜¶æ®µ â‘£: final_report_generation**
- åŠŸèƒ½ï¼šç”Ÿæˆæœ€ç»ˆç»¼åˆæŠ¥å‘Š
- ç‰¹æ€§ï¼šè‡ªåŠ¨å¤„ç† token é™åˆ¶ï¼Œæ”¯æŒé‡è¯•

#### æ‰§è¡Œæ—¶é—´ä¼°ç®—

```
æ¾„æ¸…é˜¶æ®µ:    2-5ç§’   (è°ƒç”¨1æ¬¡AI)
è§„åˆ’é˜¶æ®µ:    2-3ç§’   (è°ƒç”¨1æ¬¡AI)
æ‰§è¡Œé˜¶æ®µ:    30-60ç§’ (å¤šæ¬¡æœç´¢ + å¤šæ¬¡AIè°ƒç”¨)
æŠ¥å‘Šé˜¶æ®µ:    5-10ç§’  (è°ƒç”¨1æ¬¡AIç”Ÿæˆé•¿æ–‡æœ¬)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡:        40-80ç§’
```

---

### 3.2 ç›‘ç£è€…å­å›¾çš„è¾¹ç»“æ„

**Q: ç›‘ç£è€…å­å›¾åªæœ‰ä¸€æ¡è¾¹å—ï¼Ÿ**

```python
supervisor_builder.add_edge(START, "supervisor")  # åªæœ‰è¿™ä¸€æ¡ï¼Ÿ
```

**A: å®é™…ä¸Šæœ‰ 4 æ¡è¾¹ï¼Œå½¢æˆå¾ªç¯ç»“æ„ï¼**

#### è¾¹çš„ä¸¤ç§å®šä¹‰æ–¹å¼

1. **é™æ€è¾¹**ï¼ˆä½¿ç”¨ `add_edge()`ï¼‰
   ```python
   supervisor_builder.add_edge(START, "supervisor")
   ```

2. **åŠ¨æ€è¾¹**ï¼ˆé€šè¿‡å‡½æ•°è¿”å› `Command`ï¼‰
   ```python
   return Command(goto="supervisor_tools")  # åŠ¨æ€åˆ›å»ºè¾¹
   ```

#### å®Œæ•´çš„è¾¹ç»“æ„

```
   [START]
      â”‚
      â”‚ â‘  é™æ€è¾¹ï¼ˆadd_edge å®šä¹‰ï¼‰
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  supervisor  â”‚  â† ä¸»ç›‘ç£è€…ï¼ˆè§„åˆ’å’Œå†³ç­–ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ â‘¡ åŠ¨æ€è¾¹ï¼ˆCommand(goto="supervisor_tools")ï¼‰
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ supervisor_tools â”‚  â† å·¥å…·æ‰§è¡Œå™¨ï¼ˆæ‰§è¡Œç ”ç©¶ä»»åŠ¡ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â”‚             â”‚
      â”‚ â‘¢ å¾ªç¯è¾¹    â”‚ â‘£ ç»ˆæ­¢è¾¹
      â”‚             â”‚
      â†“             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   [END]
â”‚  supervisor  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| è¾¹ | ç±»å‹ | å®šä¹‰ä½ç½® | ä½œç”¨ |
|---|------|---------|------|
| â‘  START â†’ supervisor | é™æ€ | `add_edge()` | å…¥å£ç‚¹ |
| â‘¡ supervisor â†’ supervisor_tools | åŠ¨æ€ | `Command(goto=...)` | äº¤ç»™å·¥å…·æ‰§è¡Œ |
| â‘¢ supervisor_tools â†’ supervisor | åŠ¨æ€ | `Command(goto=...)` | å¾ªç¯ç»§ç»­ç ”ç©¶ |
| â‘£ supervisor_tools â†’ END | åŠ¨æ€ | `Command(goto=END)` | ç ”ç©¶å®Œæˆï¼Œé€€å‡º |

#### ç»ˆæ­¢æ¡ä»¶

`supervisor_tools` åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä¼šç»“æŸå¾ªç¯ï¼š

1. âœ… è¶…è¿‡æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼ˆ`max_researcher_iterations = 6`ï¼‰
2. âœ… ç›‘ç£è€…æ²¡æœ‰è°ƒç”¨ä»»ä½•å·¥å…·
3. âœ… ç›‘ç£è€…è°ƒç”¨äº† `ResearchComplete` å·¥å…·

#### å®é™…æ‰§è¡Œæµç¨‹ç¤ºä¾‹

```
[START]
   â†“
ã€ç¬¬1è½®ã€‘
   supervisor: "æˆ‘éœ€è¦3ä¸ªç ”ç©¶å•å…ƒï¼šæŠ€æœ¯ã€åº”ç”¨ã€æœªæ¥"
   â†“
   supervisor_tools: å¹¶è¡Œæ‰§è¡Œ3ä¸ªç ”ç©¶ä»»åŠ¡
   â†“ (å¾ªç¯å›å»)
   
ã€ç¬¬2è½®ã€‘
   supervisor: "æŠ€æœ¯éƒ¨åˆ†éœ€è¦æ›´å¤šç»†èŠ‚ï¼Œå†ç ”ç©¶ä¸€æ¬¡"
   â†“
   supervisor_tools: æ‰§è¡Œè¡¥å……ç ”ç©¶
   â†“ (å¾ªç¯å›å»)
   
ã€ç¬¬3è½®ã€‘
   supervisor: "ä¿¡æ¯å·²è¶³å¤Ÿï¼Œè°ƒç”¨ ResearchComplete"
   â†“
   supervisor_tools: æ£€æµ‹åˆ° ResearchCompleteï¼Œç»ˆæ­¢å¾ªç¯
   â†“
[END]
```

è¿™ç§è®¾è®¡æ¨¡å¼åœ¨ LangGraph ä¸­å«åš**"å¾ªç¯å­å›¾"**æˆ–**"è¿­ä»£å­å›¾"**ï¼Œéå¸¸é€‚åˆéœ€è¦å¤šè½®å†³ç­–å’Œæ‰§è¡Œçš„åœºæ™¯ã€‚

---

## 4. å·¥å…·ç³»ç»Ÿæ¶æ„

### 4.1 å·¥å…·çš„ä¸¤å±‚æ¶æ„

**Q: ç›‘ç£è€…çš„ä¸‰ä¸ªå·¥å…·ï¼ˆConductResearch, ResearchComplete, think_toolï¼‰çœ‹èµ·æ¥ä»€ä¹ˆéƒ½æ²¡åšï¼Ÿ**

```python
# ç›‘ç£è€…å·¥å…·å®šä¹‰
class ConductResearch(BaseModel):
    """è°ƒç”¨æ­¤å·¥å…·å¯¹ç‰¹å®šä¸»é¢˜è¿›è¡Œç ”ç©¶"""
    research_topic: str = Field(...)

class ResearchComplete(BaseModel):
    """è°ƒç”¨æ­¤å·¥å…·è¡¨ç¤ºç ”ç©¶å·²å®Œæˆ"""
    # ç©ºçš„ï¼Œåªæ˜¯ä¸€ä¸ªæ ‡è®°

@tool
def think_tool(reflection: str) -> str:
    """æˆ˜ç•¥åæ€å·¥å…·"""
    return f"åæ€å·²è®°å½•: {reflection}"  # åªæ˜¯è¿”å›ç¡®è®¤
```

**A: è¿™æ˜¯ LangGraph çš„"å·¥å…·æ‹¦æˆªæ¨¡å¼"**

#### å·¥å…·å®šä¹‰ vs å·¥å…·æ‰§è¡Œ

å·¥å…·åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š

1. **å·¥å…·å®šä¹‰ï¼ˆSchemaï¼‰** - å‘Šè¯‰ AI "ä½ å¯ä»¥è°ƒç”¨è¿™äº›å·¥å…·"
2. **å·¥å…·æ‰§è¡Œï¼ˆLogicï¼‰** - çœŸæ­£çš„é€»è¾‘åœ¨ `supervisor_tools` å‡½æ•°ä¸­

#### ä¸¤å±‚å·¥å…·æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸¤å±‚å·¥å…·æ¶æ„                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ç›‘ç£è€…å±‚ã€‘supervisor (odr_supervisor.py)
â”œâ”€ ConductResearch      â† è§„åˆ’å·¥å…·ï¼šå¯åŠ¨ç ”ç©¶ä»»åŠ¡
â”œâ”€ ResearchComplete     â† è§„åˆ’å·¥å…·ï¼šæ ‡è®°å®Œæˆ
â””â”€ think_tool           â† è§„åˆ’å·¥å…·ï¼šæˆ˜ç•¥æ€è€ƒ

ã€ç ”ç©¶è€…å±‚ã€‘researcher (odr_researcher.py)
â”œâ”€ serper_search_tool   â† æ‰§è¡Œå·¥å…·ï¼šæœç´¢ä¿¡æ¯
â”œâ”€ tavily_search        â† æ‰§è¡Œå·¥å…·ï¼šå¦ä¸€ä¸ªæœç´¢
â”œâ”€ rag_search_tool      â† æ‰§è¡Œå·¥å…·ï¼šRAGæ£€ç´¢
â””â”€ think_tool           â† æ‰§è¡Œå·¥å…·ï¼šæ€è€ƒ
```

#### çœŸæ­£çš„æ‰§è¡Œé€»è¾‘

å·¥å…·çš„å®é™…æ‰§è¡Œåœ¨ `supervisor_tools` å‡½æ•°ä¸­ï¼š

```python
async def supervisor_tools(state, config):
    """è¿™é‡Œæ‰æ˜¯çœŸæ­£æ‰§è¡Œå·¥å…·çš„åœ°æ–¹ï¼"""
    
    # è·å– AI çš„å·¥å…·è°ƒç”¨è¯·æ±‚
    tool_calls = most_recent_message.tool_calls
    
    # â‘  think_tool çš„å®é™…æ‰§è¡Œ
    think_tool_calls = [tc for tc in tool_calls if tc["name"] == "think_tool"]
    for tool_call in think_tool_calls:
        # çœŸæ­£çš„é€»è¾‘ï¼šè®°å½•åæ€
        all_tool_messages.append(ToolMessage(
            content=f"åæ€å·²è®°å½•: {tool_call['args']['reflection']}"
        ))
    
    # â‘¡ ConductResearch çš„å®é™…æ‰§è¡Œ â­ æœ€é‡è¦
    conduct_research_calls = [tc for tc in tool_calls if tc["name"] == "ConductResearch"]
    if conduct_research_calls:
        # çœŸæ­£çš„é€»è¾‘ï¼šå¯åŠ¨ç ”ç©¶è€…å­å›¾ï¼
        research_tasks = [
            researcher_subgraph.ainvoke({
                "researcher_messages": [HumanMessage(content=tc["args"]["research_topic"])],
                "research_topic": tc["args"]["research_topic"]
            }, config) 
            for tc in conduct_research_calls
        ]
        # å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰ç ”ç©¶ä»»åŠ¡
        tool_results = await asyncio.gather(*research_tasks)
    
    # â‘¢ ResearchComplete çš„å®é™…æ‰§è¡Œ
    if any(tc["name"] == "ResearchComplete" for tc in tool_calls):
        # çœŸæ­£çš„é€»è¾‘ï¼šç»ˆæ­¢å¾ªç¯ï¼Œç»“æŸç ”ç©¶
        return Command(goto=END, update={...})
```

#### ä¸‰ä¸ªå·¥å…·çš„å®é™…ä½œç”¨

| å·¥å…· | Schema å®šä¹‰ | å®é™…æ‰§è¡Œé€»è¾‘ | çœŸæ­£ä½œç”¨ |
|-----|------------|------------|---------|
| **think_tool** | æ¥æ”¶åæ€å†…å®¹ | è®°å½•åˆ°æ¶ˆæ¯ä¸­ | è®©AIæš‚åœæ€è€ƒï¼Œè§„åˆ’ä¸‹ä¸€æ­¥ |
| **ConductResearch** | æ¥æ”¶ç ”ç©¶ä¸»é¢˜ | å¯åŠ¨ç ”ç©¶è€…å­å›¾ | è§¦å‘å®é™…çš„ç ”ç©¶æµç¨‹ï¼ˆæœç´¢ã€åˆ†æï¼‰ |
| **ResearchComplete** | æ— å‚æ•° | æ£€æµ‹å¹¶ç»ˆæ­¢å¾ªç¯ | ä¿¡å·ï¼šå‘Šè¯‰ç³»ç»Ÿç ”ç©¶ç»“æŸäº† |

#### å®Œæ•´å·¥ä½œæµç¨‹ç¤ºä¾‹

```
ç”¨æˆ·é—®é¢˜: "AIçš„å‘å±•è¶‹åŠ¿"

ã€supervisor èŠ‚ç‚¹ã€‘
  AI (ç›‘ç£è€…) å†³å®šè°ƒç”¨å·¥å…·:
  tool_calls = [
    {"name": "think_tool", "args": {
      "reflection": "é—®é¢˜æ¶‰åŠæŠ€æœ¯ã€åº”ç”¨ã€æœªæ¥ä¸‰ä¸ªæ–¹å‘"
    }},
    {"name": "ConductResearch", "args": {
      "research_topic": "AIæŠ€æœ¯æ¼”è¿›ï¼šä»è§„åˆ™ç³»ç»Ÿåˆ°æ·±åº¦å­¦ä¹ "
    }},
    {"name": "ConductResearch", "args": {
      "research_topic": "AIå½“å‰ä¸»æµåº”ç”¨åœºæ™¯"
    }},
    {"name": "ConductResearch", "args": {
      "research_topic": "AIæœªæ¥å‘å±•æ–¹å‘"
    }}
  ]

ã€supervisor_tools èŠ‚ç‚¹ã€‘çœŸæ­£æ‰§è¡Œ
  
  â‘  å¤„ç† think_tool:
     â†’ è®°å½•åæ€å†…å®¹
  
  â‘¡ å¤„ç† ConductResearch (3ä¸ª):
     â†’ å¯åŠ¨ researcher_subgraph 1 (ç ”ç©¶æŠ€æœ¯æ¼”è¿›)
     â†’ å¯åŠ¨ researcher_subgraph 2 (ç ”ç©¶åº”ç”¨åœºæ™¯) 
     â†’ å¯åŠ¨ researcher_subgraph 3 (ç ”ç©¶æœªæ¥è¶‹åŠ¿)
     â†’ å¹¶è¡Œæ‰§è¡Œ (await asyncio.gather)
     â†’ ç­‰å¾…æ‰€æœ‰ç ”ç©¶å®Œæˆ
     â†’ æ”¶é›†ç ”ç©¶ç»“æœå¹¶è¿”å›
```

#### è®¾è®¡æ¨¡å¼å¯¹æ¯”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¼ ç»Ÿæ–¹å¼ï¼ˆç›´æ¥æ‰§è¡Œï¼‰                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AI è°ƒç”¨å·¥å…· â†’ å·¥å…·å‡½æ•°ç›´æ¥æ‰§è¡Œ â†’ è¿”å›ç»“æœ               â”‚
â”‚  âŒ æ— æ³•æ§åˆ¶æ‰§è¡Œæµç¨‹                                     â”‚
â”‚  âŒ æ— æ³•è¿›è¡Œå¤æ‚ç¼–æ’                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LangGraph æ–¹å¼ï¼ˆæ‹¦æˆªæ‰§è¡Œï¼‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AI è°ƒç”¨å·¥å…· â†’ supervisor_tools æ‹¦æˆª â†’ æ‰§è¡Œå¤æ‚é€»è¾‘      â”‚
â”‚                                     â†“                     â”‚
â”‚                            â€¢ å¯åŠ¨å­å›¾                     â”‚
â”‚                            â€¢ å¹¶è¡Œæ‰§è¡Œ                     â”‚
â”‚                            â€¢ çŠ¶æ€ç®¡ç†                     â”‚
â”‚                            â€¢ é”™è¯¯å¤„ç†                     â”‚
â”‚  âœ… å®Œå…¨æ§åˆ¶æ‰§è¡Œæµç¨‹                                     â”‚
â”‚  âœ… å¯ä»¥è¿›è¡Œå¤æ‚ç¼–æ’                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. å¦‚ä½•æ‰©å±•ç³»ç»Ÿ

### 5.1 æ·»åŠ æ–°çš„ç ”ç©¶å·¥å…·

**Q: æˆ‘æƒ³æ·»åŠ  RAG æ£€ç´¢å·¥å…·ã€æ•°æ®åº“æŸ¥è¯¢å·¥å…·ã€å¤©æ°”æŸ¥è¯¢å·¥å…·ç­‰ï¼Œè¦åœ¨å“ªé‡Œæ·»åŠ ï¼Ÿ**

**A: åº”è¯¥æ·»åŠ åˆ°ç ”ç©¶è€…å±‚çº§ï¼ˆresearcherï¼‰ï¼Œè€Œä¸æ˜¯ç›‘ç£è€…å±‚çº§**

#### æ·»åŠ å·¥å…·çš„å®Œæ•´æ­¥éª¤

**æ­¥éª¤ 1: åˆ›å»ºå·¥å…·æ–‡ä»¶**

ç¤ºä¾‹ - RAG æ£€ç´¢å·¥å…·ï¼š

```python
# app/services/agent_orchestration/rag_search.py
"""
RAGæ£€ç´¢å·¥å…·
ä»æœ¬åœ°å‘é‡æ•°æ®åº“æ£€ç´¢ç›¸å…³æ–‡æ¡£
"""
from langchain_core.tools import tool

@tool
async def rag_search_tool(query: str, top_k: int = 5) -> str:
    """
    ä»RAGå‘é‡æ•°æ®åº“æ£€ç´¢ç›¸å…³æ–‡æ¡£
    
    Args:
        query: æ£€ç´¢æŸ¥è¯¢
        top_k: è¿”å›ç»“æœæ•°é‡
    
    Returns:
        æ ¼å¼åŒ–çš„æ£€ç´¢ç»“æœ
    """
    try:
        # TODO: å®ç°å®é™…çš„RAGæ£€ç´¢é€»è¾‘
        # from your_vector_store import search_similar_docs
        # results = await search_similar_docs(query, top_k)
        
        results = [...]  # æ£€ç´¢ç»“æœ
        
        # æ ¼å¼åŒ–ç»“æœ
        formatted_results = []
        for i, result in enumerate(results[:top_k], 1):
            formatted_result = f"""
æ–‡æ¡£ {i}:
å†…å®¹: {result['content']}
ç›¸ä¼¼åº¦: {result['score']:.2f}
æ¥æº: {result['source']}
"""
            formatted_results.append(formatted_result)
        
        return "\n".join(formatted_results)
        
    except Exception as e:
        return f"RAGæ£€ç´¢å¤±è´¥: {str(e)}"
```

ç¤ºä¾‹ - æ•°æ®åº“æŸ¥è¯¢å·¥å…·ï¼š

```python
# app/services/agent_orchestration/database_query.py
"""
æ•°æ®åº“æŸ¥è¯¢å·¥å…·
"""
from langchain_core.tools import tool

@tool
async def database_query_tool(query: str, database: str = "default") -> str:
    """
    æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
    
    Args:
        query: SQLæŸ¥è¯¢è¯­å¥
        database: æ•°æ®åº“åç§°
    
    Returns:
        æŸ¥è¯¢ç»“æœ
    """
    try:
        # TODO: å®ç°å®é™…çš„æ•°æ®åº“æŸ¥è¯¢
        # import asyncpg
        # conn = await asyncpg.connect('postgresql://...')
        # results = await conn.fetch(query)
        
        results = [...]  # æŸ¥è¯¢ç»“æœ
        
        formatted_results = "æŸ¥è¯¢ç»“æœ:\n"
        for row in results:
            formatted_results += f"- {row}\n"
        
        return formatted_results
        
    except Exception as e:
        return f"æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: {str(e)}"
```

ç¤ºä¾‹ - å¤©æ°”æŸ¥è¯¢å·¥å…·ï¼š

```python
# app/services/agent_orchestration/weather_query.py
"""
å¤©æ°”æŸ¥è¯¢å·¥å…·
"""
import aiohttp
import os
from langchain_core.tools import tool

@tool
async def weather_query_tool(location: str, units: str = "metric") -> str:
    """
    æŸ¥è¯¢å¤©æ°”ä¿¡æ¯
    
    Args:
        location: åŸå¸‚åç§°
        units: æ¸©åº¦å•ä½
    
    Returns:
        å¤©æ°”ä¿¡æ¯
    """
    try:
        api_key = os.getenv("OPENWEATHER_API_KEY")
        url = f"https://api.openweathermap.org/data/2.5/weather"
        params = {"q": location, "appid": api_key, "units": units}
        
        async with aiohttp.ClientSession() as session:
            async with session.get(url, params=params) as response:
                if response.status == 200:
                    data = await response.json()
                    return f"å¤©æ°”: {data['weather'][0]['description']}, æ¸©åº¦: {data['main']['temp']}Â°C"
                else:
                    return f"å¤©æ°”æŸ¥è¯¢å¤±è´¥: HTTP {response.status}"
        
    except Exception as e:
        return f"å¤©æ°”æŸ¥è¯¢é”™è¯¯: {str(e)}"
```

**æ­¥éª¤ 2: æ³¨å†Œå·¥å…·**

ä¿®æ”¹ `app/services/agent_orchestration/odr_utils.py`ï¼š

```python
# åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
from .serper_search import serper_search_tool
from .rag_search import rag_search_tool           # ğŸ‘ˆ æ–°å¢
from .database_query import database_query_tool    # ğŸ‘ˆ æ–°å¢
from .weather_query import weather_query_tool      # ğŸ‘ˆ æ–°å¢

# ä¿®æ”¹ get_all_tools å‡½æ•°
async def get_all_tools(config: RunnableConfig) -> List[BaseTool]:
    """è·å–æ‰€æœ‰å¯ç”¨å·¥å…·"""
    tools = []
    
    # æ·»åŠ æœç´¢å·¥å…·
    configurable = Configuration.from_runnable_config(config)
    if configurable.search_api == SearchAPI.SERPER:
        tools.append(serper_search_tool)
    
    # æ·»åŠ think_tool
    tools.append(think_tool)
    
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ‘‡ æ·»åŠ ä½ çš„æ–°å·¥å…·
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # æ·»åŠ RAGæ£€ç´¢å·¥å…·
    tools.append(rag_search_tool)
    
    # æ·»åŠ æ•°æ®åº“æŸ¥è¯¢å·¥å…·
    tools.append(database_query_tool)
    
    # æ·»åŠ å¤©æ°”æŸ¥è¯¢å·¥å…·
    tools.append(weather_query_tool)
    
    return tools
```

#### å·¥å…·è°ƒç”¨æµç¨‹

```
ç”¨æˆ·é—®é¢˜: "åˆ†æåŒ—äº¬çš„AIå…¬å¸å‘å±•æƒ…å†µå’Œå¤©æ°”å½±å“"

ã€ç›‘ç£è€…ã€‘supervisor
   â†“
   è°ƒç”¨ ConductResearch("åˆ†æåŒ—äº¬AIå…¬å¸")
   â†“
ã€ç ”ç©¶è€…ã€‘researcher
   â†“
   å¯ç”¨å·¥å…·: [serper, rag, database, weather, think] ğŸ‘ˆ æ–°å·¥å…·åœ¨è¿™é‡Œ
   â†“
   AIè‡ªä¸»å†³ç­–è°ƒç”¨å·¥å…·ï¼š
   â”œâ”€ serper_search_tool("åŒ—äº¬äººå·¥æ™ºèƒ½å…¬å¸")
   â”œâ”€ database_query_tool("SELECT * FROM companies WHERE city='åŒ—äº¬'")
   â”œâ”€ weather_query_tool("åŒ—äº¬")
   â””â”€ rag_search_tool("AIå…¬å¸å‘å±•æŠ¥å‘Š")
   â†“
ã€researcher_toolsã€‘æ‰§è¡Œå·¥å…·å¹¶æ”¶é›†ç»“æœ
   â†“
   è¿”å›ç»¼åˆç ”ç©¶æŠ¥å‘Š
```

#### é…ç½®å·¥å…·å¼€å…³ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦å¼€å…³æ§åˆ¶æŸäº›å·¥å…·ï¼Œå¯ä»¥åœ¨é…ç½®ä¸­æ·»åŠ ï¼š

```python
# app/services/agent_orchestration/odr_configuration.py
class Configuration(BaseModel):
    # ... ç°æœ‰é…ç½® ...
    
    # æ–°å¢å·¥å…·å¼€å…³
    enable_rag: bool = True
    enable_database: bool = True
    enable_weather: bool = True
```

ç„¶ååœ¨ `get_all_tools` ä¸­æ¡ä»¶æ·»åŠ ï¼š

```python
async def get_all_tools(config: RunnableConfig) -> List[BaseTool]:
    tools = []
    configurable = Configuration.from_runnable_config(config)
    
    # æœç´¢å·¥å…·ï¼ˆå¿…é€‰ï¼‰
    if configurable.search_api == SearchAPI.SERPER:
        tools.append(serper_search_tool)
    
    # å¯é€‰å·¥å…·
    if configurable.enable_rag:
        tools.append(rag_search_tool)
    
    if configurable.enable_database:
        tools.append(database_query_tool)
    
    if configurable.enable_weather:
        tools.append(weather_query_tool)
    
    tools.append(think_tool)
    
    return tools
```

---

### 5.2 å·¥å…·åˆ†ç±»æ€»ç»“

| å±‚çº§ | å·¥å…·ç±»å‹ | ä½œç”¨ | ç¤ºä¾‹ |
|-----|---------|------|------|
| **ç›‘ç£è€…å±‚** | è§„åˆ’å·¥å…· | æ§åˆ¶ç ”ç©¶æµç¨‹ | ConductResearch, ResearchComplete, think_tool |
| **ç ”ç©¶è€…å±‚** | æ‰§è¡Œå·¥å…· | è·å–å®é™…æ•°æ® | serper_search, rag_search, database_query, weather_query |

**è®°ä½**ï¼š
- âœ… æ·»åŠ æ–°çš„æ•°æ®è·å–å·¥å…· â†’ **ç ”ç©¶è€…å±‚**
- âœ… ä¿®æ”¹ç ”ç©¶æµç¨‹æ§åˆ¶ â†’ **ç›‘ç£è€…å±‚**
- âœ… ç ”ç©¶è€… AI ä¼šè‡ªåŠ¨æ ¹æ®ä»»åŠ¡æ™ºèƒ½é€‰æ‹©åˆé€‚çš„å·¥å…·

---

## é™„å½•ï¼šå…³é”®æ–‡ä»¶ç´¢å¼•

| æ–‡ä»¶è·¯å¾„ | ä½œç”¨ |
|---------|------|
| `app/router/enhanced_research_router_simple.py` | FastAPI è·¯ç”±å±‚ |
| `app/services/research_service.py` | æœåŠ¡å±‚ï¼ˆexecute_research_task_streamï¼‰ |
| `app/services/agent_orchestration/odr_orchestrator.py` | ç¼–æ’å™¨ï¼ˆprocess_research_requestï¼‰ |
| `app/services/agent_orchestration/odr_main.py` | ä¸»å·¥ä½œæµå›¾ï¼ˆdeep_researcherï¼‰ |
| `app/services/agent_orchestration/odr_supervisor.py` | ç›‘ç£è€…å­å›¾ |
| `app/services/agent_orchestration/odr_researcher.py` | ç ”ç©¶è€…å­å›¾ |
| `app/services/agent_orchestration/odr_utils.py` | å·¥å…·é›†åˆï¼ˆget_all_toolsï¼‰ |
| `app/services/agent_orchestration/odr_state.py` | çŠ¶æ€å®šä¹‰ |
| `app/services/agent_orchestration/odr_configuration.py` | é…ç½®å®šä¹‰ |

---

## æ€»ç»“

### æ ¸å¿ƒæ¦‚å¿µå›é¡¾

1. **æµå¼å“åº”æ¶æ„** - ä½¿ç”¨ `async for` + `yield` å®ç°å®æ—¶è¿›åº¦æ¨é€
2. **ä¸‰å±‚æ¶æ„** - è·¯ç”±å±‚ã€å°è£…å±‚ã€æ ¸å¿ƒå±‚èŒè´£åˆ†ç¦»
3. **LangGraph å·¥ä½œæµ** - å››é˜¶æ®µç ”ç©¶æµç¨‹ï¼ˆæ¾„æ¸… â†’ è§„åˆ’ â†’ æ‰§è¡Œ â†’ æŠ¥å‘Šï¼‰
4. **å·¥å…·æ‹¦æˆªæ¨¡å¼** - å·¥å…·å®šä¹‰æ˜¯æ¥å£ï¼Œå®é™…é€»è¾‘åœ¨æ‹¦æˆªå™¨ä¸­
5. **ä¸¤å±‚å·¥å…·æ¶æ„** - ç›‘ç£è€…å±‚ï¼ˆè§„åˆ’å·¥å…·ï¼‰+ ç ”ç©¶è€…å±‚ï¼ˆæ‰§è¡Œå·¥å…·ï¼‰

### è®¾è®¡ä¼˜åŠ¿

- âœ… **å®æ—¶åé¦ˆ** - ç”¨æˆ·ä¸ç”¨ç­‰åˆ°æœ€åæ‰çœ‹åˆ°ç»“æœ
- âœ… **èŒè´£åˆ†ç¦»** - æ¯å±‚ã€æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰æ¸…æ™°çš„èŒè´£
- âœ… **å¯æ‰©å±•æ€§** - è½»æ¾æ·»åŠ æ–°å·¥å…·ã€æ–°èŠ‚ç‚¹
- âœ… **å¹¶è¡ŒåŒ–** - å¤šä¸ªç ”ç©¶å•å…ƒå¯ä»¥å¹¶è¡Œæ‰§è¡Œ
- âœ… **å®¹é”™æ€§** - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œè¶…æ—¶ä¿æŠ¤

---

*æœ€åæ›´æ–°æ—¶é—´ï¼š2025-10-08*
*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*

